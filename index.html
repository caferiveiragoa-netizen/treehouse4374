<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TreeHouse Bakery - Order Now!</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f8f9fa; }
    .menu-category { color: #dc3545; border-bottom: 2px solid #dc3545; padding-bottom: 5px; margin-top: 20px; }
    .menu-item { background-color: white; transition: background-color 0.2s; }
    .menu-item:hover { background-color: #f1f1f1; }
    .cart-section { border: 1px solid #ddd; border-radius: 8px; }
    .cart-item { background-color: #fff; padding: 10px; margin-bottom: 5px; border: 1px solid #eee; border-radius: 5px; }
    @media (max-width: 768px) { .menu-category { font-size: 1.2rem; } }
    .admin-link { text-align: center; margin-top: 10px; font-size: 0.8rem; }
  </style>
</head>
<body>

  <div class="container-fluid p-0">
    <!-- Header -->
    <header class="bg-dark text-white text-center py-3">
      <h1>TreeHouse Bakery</h1>
      <p>Scan QR ‚Ä¢ Order ‚Ä¢ Delivered to Your Room</p>
    </header>

    <!-- Menu Categories -->
    <div class="row g-3 p-3">
      <div class="col-12 col-md-6 col-lg-4">
        <h3 class="menu-category">üçï Pizza</h3>
        <div id="pizza-menu" class="menu-items"></div>
      </div>
      <div class="col-12 col-md-6 col-lg-4">
        <h3 class="menu-category">üçî Burger</h3>
        <div id="burger-menu" class="menu-items"></div>
      </div>
      <div class="col-12 col-md-6 col-lg-4">
        <h3 class="menu-category">ü•™ Sandwich</h3>
        <div id="sandwich-menu" class="menu-items"></div>
      </div>
      <div class="col-12 col-md-6 col-lg-4">
        <h3 class="menu-category">üßá Waffles & Shake</h3>
        <div id="waffle-menu" class="menu-items"></div>
      </div>
      <div class="col-12 col-md-6 col-lg-4">
        <h3 class="menu-category">‚òï Tea/Coffee & More</h3>
        <div id="tea-menu" class="menu-items"></div>
      </div>
    </div>

    <!-- Cart Section -->
    <div class="cart-section bg-light p-3 mt-4">
      <h4>Your Order</h4>
      <div id="cart-items" class="mb-3"></div>
      <div class="d-flex justify-content-between mb-3">
        <strong>Total:</strong>
        <span id="cart-total">‚Çπ0</span>
      </div>
      <div class="mb-3">
        <input type="text" id="customer-name" class="form-control mb-2" placeholder="Your Full Name" required>
        <input type="tel" id="customer-phone" class="form-control mb-2" placeholder="Phone Number" required>
        <input type="text" id="room-number" class="form-control mb-2" placeholder="Hotel Room Number" required>
      </div>
      <button id="pay-button" class="btn btn-success w-100">Pay via UPI ‚Üí</button>
    </div>

    <!-- Footer -->
    <footer class="bg-dark text-white text-center py-3 mt-4">
      <p>¬© 2025 TreeHouse Bakery | Scan QR in Your Hotel Room</p>
      <p class="admin-link"><a href="admin.html" style="color: #dc3545; font-size: 0.8rem; text-decoration: underline;">Admin Login</a></p>
    </footer>
  </div>

  <!-- Audio Alert -->
  <audio id="buzz-sound" src="assets/buzz.mp3" preload="auto"></audio>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <script>
    // Initialize Firebase (Replace with your config later)
    const firebaseConfig = {
      apiKey: "AIzaSyAaet1l1-eryjGpeGgMDZriQT7KEW1AlyE",
      authDomain: "treehouse-f45df.firebaseapp.com",
      databaseURL: "https://treehouse-f45df-default-rtdb.firebaseio.com",
      projectId:  "treehouse-f45df",
      storageBucket: "treehouse-f45df.firebasestorage.app",
      messagingSenderId: "233268455151",
      appId: "1:233268455151:web:1341a86984e416ec475d1a",
    };

    firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // Global Variables
  let cart = [];
  let menuData = [];

  // Load Menu from Firebase
  document.addEventListener('DOMContentLoaded', () => {
    db.ref('menu').on('value', (snapshot) => {
      const data = snapshot.val();
      if (data) {
        menuData = Object.values(data);
        loadMenu();
        updateCartUI();
      }
    });
  });

  function loadMenu() {
    const categories = {
      pizza: document.getElementById('pizza-menu'),
      burger: document.getElementById('burger-menu'),
      sandwich: document.getElementById('sandwich-menu'),
      waffle: document.getElementById('waffle-menu'),
      tea: document.getElementById('tea-menu')
    };

    // Clear existing items
    Object.keys(categories).forEach(cat => {
      categories[cat].innerHTML = '';
    });

    menuData.forEach(item => {
      if (item.outOfStock) return;
      const div = document.createElement('div');
      div.className = 'menu-item d-flex justify-content-between align-items-center mb-2 p-2 border rounded';
      div.innerHTML = `
        <span>${item.name}</span>
        <span>‚Çπ${item.price}</span>
        <button class="btn btn-sm btn-outline-primary" onclick="addToCart(${item.id})">+</button>
      `;
      categories[item.category].appendChild(div);
    });
  }

  // Add to Cart
  function addToCart(itemId) {
    const item = menuData.find(i => i.id === itemId);
    if (!item) return;

    const existing = cart.find(c => c.id === itemId);
    if (existing) {
      existing.qty += 1;
    } else {
      cart.push({ ...item, qty: 1 });
    }

    updateCartUI();
    playBuzzSound();
  }

  // Update Cart UI with +/- Buttons
  function updateCartUI() {
    const cartItemsDiv = document.getElementById('cart-items');
    const cartTotalSpan = document.getElementById('cart-total');

    if (cart.length === 0) {
      cartItemsDiv.innerHTML = '<p class="text-muted">Your cart is empty.</p>';
      cartTotalSpan.textContent = '‚Çπ0';
      return;
    }

    let total = 0;
    let html = '';

    cart.forEach((item, index) => {
      const itemTotal = item.price * item.qty;
      total += itemTotal;
      html += `
        <div class="d-flex justify-content-between align-items-center mb-1">
          <span>${item.name}</span>
          <div class="d-flex align-items-center">
            <button class="btn btn-sm btn-outline-secondary me-1" onclick="decreaseQty(${index})">‚Äì</button>
            <span class="mx-2">${item.qty}</span>
            <button class="btn btn-sm btn-outline-secondary ms-1" onclick="increaseQty(${index})">+</button>
          </div>
          <span>‚Çπ${itemTotal}</span>
        </div>
      `;
    });

    cartItemsDiv.innerHTML = html;
    cartTotalSpan.textContent = `‚Çπ${total}`;
  }

  // Increase Quantity
  function increaseQty(index) {
    cart[index].qty += 1;
    updateCartUI();
    playBuzzSound();
  }

  // Decrease Quantity
  function decreaseQty(index) {
    if (cart[index].qty > 1) {
      cart[index].qty -= 1;
    } else {
      cart.splice(index, 1); // Remove item if qty becomes 0
    }
    updateCartUI();
    playBuzzSound();
  }

  // Place Order Button Click ‚Üí Redirect to WhatsApp
  document.getElementById('pay-button').addEventListener('click', () => {
    const name = document.getElementById('customer-name').value.trim();
    const phone = document.getElementById('customer-phone').value.trim();
    const room = document.getElementById('room-number').value.trim();

    if (!name || !phone || !room) {
      alert('Please fill all fields!');
      return;
    }

    if (cart.length === 0) {
      alert('Your cart is empty!');
      return;
    }

    const total = cart.reduce((sum, item) => sum + item.price * item.qty, 0);

    // Generate WhatsApp message with Order ID
    const orderId = Date.now();
    const orderDetails = cart.map(item => `${item.name} x${item.qty}`).join(', ');
    const whatsappMsg = `ORDER #${orderId}: ${name} Room ${room} - ${orderDetails} Total: ‚Çπ${total}\n\nPlease confirm upon my payment ‚Çπ${total} via UPI to 9673553554@ptsbi and i will reply with screenshot once payment is sent.`;

    // Save order to Firebase (status: pending_payment)
    const newOrder = {
      id: orderId,
      customer: { name, phone, room },
      items: cart.map(item => ({ name: item.name, price: item.price, qty: item.qty })),
      total,
      status: 'pending_payment',
      timestamp: new Date().toISOString()
    };

    db.ref('orders/' + orderId).set(newOrder)
      .then(() => {
        console.log('Order saved to Firebase');
        // Do not play buzz sound here ‚Äî we'll handle it in admin panel
      })
      .catch(error => {
        console.error('Error saving order:', error);
        alert('Failed to save order. Please try again.');
        return;
      });

    // Redirect to WhatsApp with message
    const whatsappUrl = `https://wa.me/919673553554?text=${encodeURIComponent(whatsappMsg)}`;

    window.location.href = whatsappUrl;

    // Clear cart
    cart = [];
    updateCartUI();
  });

  // Play Buzz Sound (only for admin, not customer)
  function playBuzzSound() {
    // Do nothing here ‚Äî we'll play sound in admin panel only
  }
</script>
</body>
</html>