<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Panel - TreeHouse Bakery</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f8f9fa; }
    .menu-category { color: #dc3545; border-bottom: 2px solid #dc3545; padding-bottom: 5px; margin-top: 20px; }
    .menu-item { background-color: white; transition: background-color 0.2s; }
    .menu-item:hover { background-color: #f1f1f1; }
    .cart-section { border: 1px solid #ddd; border-radius: 8px; }
    .cart-item { background-color: #fff; padding: 10px; margin-bottom: 5px; border: 1px solid #eee; border-radius: 5px; }
    .tab-content { padding: 20px; background-color: white; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
    .modal-dialog { width: 400px; max-width: 90%; }
    .list-group-item { cursor: pointer; }
    .list-group-item:hover { background-color: #f8f9fa; }
    @media (max-width: 768px) { .menu-category { font-size: 1.2rem; } }
  </style>
</head>
<body>

  <div id="login-screen" class="container-fluid d-flex justify-content-center align-items-center vh-100">
    <div class="card p-4" style="max-width: 400px;">
      <h3 class="text-center mb-4">Admin Login</h3>
      <input type="password" id="admin-password" class="form-control mb-3" placeholder="Password" />
      <button id="login-btn" class="btn btn-primary w-100">Login</button>
    </div>
  </div>

  <div id="admin-panel" class="container-fluid d-none">
    <header class="bg-dark text-white p-3 d-flex justify-content-between align-items-center">
      <h1>TreeHouse Bakery Admin</h1>
      <button id="logout-btn" class="btn btn-outline-light">Logout</button>
    </header>

    <div class="row mt-3">
      <!-- Sidebar -->
      <div class="col-md-3">
        <div class="list-group">
          <a href="#" class="list-group-item list-group-item-action active" data-tab="dashboard">Dashboard</a>
          <a href="#" class="list-group-item list-group-item-action" data-tab="menu">Menu Management</a>
          <a href="#" class="list-group-item list-group-item-action" data-tab="orders">Current Orders</a>
          <a href="#" class="list-group-item list-group-item-action" data-tab="past-orders">Past Orders</a>
          <a href="#" class="list-group-item list-group-item-action" data-tab="settings">Settings</a>
          <a href="#" class="list-group-item list-group-item-action" data-tab="reports">Reports</a>
        </div>
      </div>

      <!-- Main Content -->
      <div class="col-md-9">
        <!-- Dashboard Tab -->
        <div id="dashboard-tab" class="tab-content">
          <h4>Today's Summary</h4>
          <div class="row mb-4">
            <div class="col-6">
              <div class="card bg-info text-white">
                <div class="card-body">
                  <h5>Total Orders</h5>
                  <span id="total-orders">0</span>
                </div>
              </div>
            </div>
            <div class="col-6">
              <div class="card bg-success text-white">
                <div class="card-body">
                  <h5>Total Revenue</h5>
                  <span id="total-revenue">â‚¹0</span>
                </div>
              </div>
            </div>
          </div>
          <button id="day-close-btn" class="btn btn-danger">Day Close & Print Summary</button>
        </div>

        <!-- Menu Tab -->
        <div id="menu-tab" class="tab-content d-none">
          <h4>Menu Management</h4>
          <div class="mb-3">
            <button id="add-item-btn" class="btn btn-primary">+ Add New Item</button>
          </div>
          <div id="menu-list" class="list-group"></div>
        </div>

        <!-- Orders Tab -->
        <div id="orders-tab" class="tab-content d-none">
          <h4>Current Orders</h4>
          <div id="current-orders-list" class="list-group"></div>
        </div>

        <!-- Past Orders Tab -->
        <div id="past-orders-tab" class="tab-content d-none">
          <h4>Past Orders</h4>
          <div id="past-orders-list" class="list-group"></div>
        </div>

        <!-- Settings Tab -->
        <div id="settings-tab" class="tab-content d-none">
          <h4>Settings</h4>
          <div class="mb-3">
            <label>UPI ID:</label>
            <input type="text" id="upi-id" class="form-control mb-2" value="9673553554@ptsbi" />
          </div>
          <div class="mb-3">
            <label>Hotel Name:</label>
            <input type="text" id="hotel-name" class="form-control mb-2" value="Taj Mahal Palace" />
          </div>
          <button id="save-settings-btn" class="btn btn-success">Save Settings</button>
        </div>

        <!-- Reports Tab -->
        <div id="reports-tab" class="tab-content d-none">
          <h4>Daily Sales Report</h4>
          <div id="sales-report" class="bg-light p-3 rounded">
            Loading...
          </div>
          <button id="print-report-btn" class="btn btn-primary mt-3">Print Today's Sales</button>
        </div>
      </div>
    </div>

    <!-- Hidden Modal for Add/Edit Item -->
    <div id="item-modal" class="modal d-none">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Add/Edit Item</h5>
            <button type="button" class="btn-close" onclick="closeModal()"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="edit-item-id" />
            <div class="mb-3">
              <label>Name:</label>
              <input type="text" id="item-name" class="form-control" />
            </div>
            <div class="mb-3">
              <label>Category:</label>
              <select id="item-category" class="form-select">
                <option value="pizza">Pizza</option>
                <option value="burger">Burger</option>
                <option value="sandwich">Sandwich</option>
                <option value="waffle">Waffles & Shake</option>
                <option value="tea">Tea/Coffee & More</option>
              </select>
            </div>
            <div class="mb-3">
              <label>Price (â‚¹):</label>
              <input type="number" id="item-price" class="form-control" />
            </div>
            <div class="mb-3">
              <label>Out of Stock?</label>
              <input type="checkbox" id="item-out-of-stock" />
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button type="button" id="save-item-btn" class="btn btn-primary">Save</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <audio id="buzz-sound" src="assets/buzz.mp3" preload="auto"></audio>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <script>
    // Initialize Firebase (Replace with your config later)
    const firebaseConfig = {
      apiKey: "AIzaSyAaet1l1-eryjGpeGgMDZriQT7KEW1AlyE",
      authDomain: "treehouse-f45df.firebaseapp.com",
      databaseURL: "https://treehouse-f45df-default-rtdb.firebaseio.com",
      projectId:  "treehouse-f45df",
      storageBucket: "treehouse-f45df.firebasestorage.app",
      messagingSenderId: "233268455151",
      appId: "1:233268455151:web:1341a86984e416ec475d1a",
    };

    firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // Global Variables
  let menuData = [];

  // Admin Login Logic
  document.getElementById('login-btn').addEventListener('click', () => {
    const pass = document.getElementById('admin-password').value;
    if (pass === 'tree123') {
      document.getElementById('login-screen').classList.add('d-none');
      document.getElementById('admin-panel').classList.remove('d-none');
      loadAdminData();
    } else {
      alert('Wrong password!');
    }
  });

  // Logout
  document.getElementById('logout-btn').addEventListener('click', () => {
    document.getElementById('admin-panel').classList.add('d-none');
    document.getElementById('login-screen').classList.remove('d-none');
    document.getElementById('admin-password').value = '';
  });

  // Tab Switching
  document.querySelectorAll('[data-tab]').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.preventDefault();
      const tabId = e.target.getAttribute('data-tab');
      document.querySelectorAll('.tab-content').forEach(el => el.classList.add('d-none'));
      document.getElementById(`${tabId}-tab`).classList.remove('d-none');
      document.querySelectorAll('.list-group-item').forEach(el => el.classList.remove('active'));
      e.target.classList.add('active');
    });
  });

  // Load Admin Data
  function loadAdminData() {
    renderDashboard();
    renderMenuList();
    renderCurrentOrders();
    renderPastOrders();
  }

  // Render Dashboard (Real-Time)
  function renderDashboard() {
    db.ref('orders').on('value', (snapshot) => {
      const data = snapshot.val();
      if (!data) {
        document.getElementById('total-orders').textContent = '0';
        document.getElementById('total-revenue').textContent = 'â‚¹0';
        return;
      }

      const today = new Date().toDateString();
      const todayOrders = Object.values(data).filter(o => 
        new Date(o.timestamp).toDateString() === today
      );
      const totalRevenue = todayOrders.reduce((sum, o) => sum + o.total, 0);

      document.getElementById('total-orders').textContent = todayOrders.length;
      document.getElementById('total-revenue').textContent = `â‚¹${totalRevenue}`;
    });
  }

  // Render Menu List (ALL ITEMS)
  function renderMenuList() {
    const menuList = document.getElementById('menu-list');
    menuList.innerHTML = '';

    menuData.forEach(item => {
      const div = document.createElement('div');
      div.className = 'list-group-item d-flex justify-content-between align-items-center';
      div.innerHTML = `
        <span>${item.name} - â‚¹${item.price}</span>
        <div>
          <button class="btn btn-sm btn-warning me-1" onclick="editItem(${item.id})">Edit</button>
          <button class="btn btn-sm btn-danger" onclick="deleteItem(${item.id})">Delete</button>
        </div>
      `;
      menuList.appendChild(div);
    });
  }

  // Edit Item
  function editItem(id) {
    const item = menuData.find(i => i.id === id);
    if (!item) return;

    document.getElementById('edit-item-id').value = id;
    document.getElementById('item-name').value = item.name;
    document.getElementById('item-category').value = item.category;
    document.getElementById('item-price').value = item.price;
    document.getElementById('item-out-of-stock').checked = item.outOfStock;
    document.getElementById('item-modal').classList.remove('d-none');
  }

  // Save Item
  document.getElementById('save-item-btn').addEventListener('click', () => {
    const id = parseInt(document.getElementById('edit-item-id').value);
    const name = document.getElementById('item-name').value;
    const category = document.getElementById('item-category').value;
    const price = parseInt(document.getElementById('item-price').value);
    const outOfStock = document.getElementById('item-out-of-stock').checked;

    const itemIndex = menuData.findIndex(i => i.id === id);
    if (itemIndex !== -1) {
      menuData[itemIndex] = { id, name, category, price, outOfStock };
      alert(`Saved: ${name} - â‚¹${price} (${category}) [Out of Stock: ${outOfStock}]`);
    }

    closeModal();
    renderMenuList();
    saveMenuToFirebase(); // Save to Firebase
  });

  // Close Modal
  function closeModal() {
    document.getElementById('item-modal').classList.add('d-none');
  }

  // Add New Item
  document.getElementById('add-item-btn').addEventListener('click', () => {
    document.getElementById('edit-item-id').value = '';
    document.getElementById('item-name').value = '';
    document.getElementById('item-category').value = 'pizza';
    document.getElementById('item-price').value = '';
    document.getElementById('item-out-of-stock').checked = false;
    document.getElementById('item-modal').classList.remove('d-none');
  });

  // Delete Item
  function deleteItem(id) {
    const itemIndex = menuData.findIndex(i => i.id === id);
    if (itemIndex !== -1) {
      menuData.splice(itemIndex, 1);
      alert(`Item deleted.`);
      renderMenuList();
      saveMenuToFirebase(); // Save to Firebase
    }
  }

  // Render Current Orders (Real-Time from Firebase)
  function renderCurrentOrders() {
    const ordersList = document.getElementById('current-orders-list');

    db.ref('orders').orderByChild('status').equalTo('pending_payment').on('value', (snapshot) => {
      const data = snapshot.val();
      if (!data) {
        ordersList.innerHTML = '<p class="text-muted p-3">No current orders.</p>';
        return;
      }

      let html = '';
      Object.keys(data).forEach(key => {
        const order = data[key];
        html += `
          <div class="list-group-item">
            <strong>Order #${order.id}</strong><br>
            ${order.customer.name} | Room ${order.customer.room}<br>
            Phone: ${order.customer.phone}<br>
            ${order.items.map(item => `${item.name} x${item.qty}`).join(', ')}<br>
            Total: â‚¹${order.total}<br>
            <div class="mt-2">
              <button class="btn btn-sm btn-primary" onclick="confirmOrder('${order.id}')">âœ… Confirm Order</button>
              <button class="btn btn-sm btn-secondary" onclick="printReceipt('${order.id}')">Print Receipt</button>
            </div>
          </div>
        `;
      });

      ordersList.innerHTML = html;
    });
  }

  // Render Past Orders (from Firebase)
  function renderPastOrders() {
    const ordersList = document.getElementById('past-orders-list');

    db.ref('orders').orderByChild('status').equalTo('delivered').on('value', (snapshot) => {
      const data = snapshot.val();
      if (!data) {
        ordersList.innerHTML = '<p class="text-muted p-3">No past orders.</p>';
        return;
      }

      let html = '';
      Object.keys(data).forEach(key => {
        const order = data[key];
        html += `
          <div class="list-group-item">
            <strong>Order #${order.id}</strong><br>
            ${order.customer.name} | Room ${order.customer.room}<br>
            Phone: ${order.customer.phone}<br>
            ${order.items.map(item => `${item.name} x${item.qty}`).join(', ')}<br>
            Total: â‚¹${order.total}<br>
            <div class="mt-2">
              <button class="btn btn-sm btn-secondary" onclick="printReceipt('${order.id}')">Print Receipt</button>
            </div>
          </div>
        `;
      });

      ordersList.innerHTML = html;
    });
  }

  // âœ… NEW: Confirm Order Button â†’ Mark as Confirmed + Send WhatsApp Message
  function confirmOrder(id) {
    db.ref('orders/' + id).once('value')
      .then(snapshot => {
        const order = snapshot.val();
        if (!order) return;

        // Update order status to "confirmed"
        db.ref('orders/' + id).update({ status: 'confirmed' })
          .then(() => {
            // Generate WhatsApp message to customer
            const whatsappMsg = `Hi ${order.customer.name}, your order #${order.id} is confirmed! We'll deliver it to Room ${order.customer.room} in 20 minutes. Thank you for choosing TreeHouse Bakery! ðŸ•`;

            // Open WhatsApp with message
            const whatsappUrl = `https://wa.me/${order.customer.phone}?text=${encodeURIComponent(whatsappMsg)}`;

            window.open(whatsappUrl, '_blank');

            alert(`Order #${id} confirmed! WhatsApp message sent to ${order.customer.phone}`);
            renderCurrentOrders();
          })
          .catch(error => {
            console.error('Error confirming order:', error);
            alert('Failed to confirm order. Please try again.');
          });
      })
      .catch(error => {
        console.error('Error fetching order:', error);
        alert('Failed to fetch order. Please try again.');
      });
  }

  // Mark Order as Ready
  function markReady(id) {
    db.ref('orders/' + id).update({ status: 'ready' })
      .then(() => {
        console.log('Order marked as ready');
      })
      .catch(error => {
        console.error('Error updating order:', error);
        alert('Failed to update order. Please try again.');
      });
  }

  // Mark Order as Picked Up
  function markPickedUp(id) {
    db.ref('orders/' + id).update({ status: 'picked_up' })
      .then(() => {
        console.log('Order marked as picked up');
      })
      .catch(error => {
        console.error('Error updating order:', error);
        alert('Failed to update order. Please try again.');
      });
  }

  // Mark Order as Delivered
  function markDelivered(id) {
    db.ref('orders/' + id).update({ status: 'delivered' })
      .then(() => {
        console.log('Order marked as delivered');
        // Play buzz sound (optional)
        const audio = document.getElementById('buzz-sound');
        audio.currentTime = 0;
        audio.play().catch(e => console.log("Audio play failed:", e));
      })
      .catch(error => {
        console.error('Error updating order:', error);
        alert('Failed to update order. Please try again.');
      });
  }

  // Print Receipt
  function printReceipt(id) {
    db.ref('orders/' + id).once('value')
      .then(snapshot => {
        const order = snapshot.val();
        if (!order) return;

        const receipt = `
          ----------------------------------
                TREEHOUSE BAKERY
             www.treehousebakery.com
             +91 9673553554
          ----------------------------------
          ORDER #${id}
          Date: ${new Date(order.timestamp).toLocaleString()}
          Room: ${order.customer.room} | Guest: ${order.customer.name}
          Phone: ${order.customer.phone}
          ----------------------------------
          ITEM                  QTY   AMT
          ----------------------------------
          ${order.items.map(item => `${item.name.padEnd(20)} ${item.qty}    â‚¹${item.price * item.qty}`).join('\n')}
          ----------------------------------
          TOTAL:                â‚¹${order.total}
          ----------------------------------
          STATUS: ${order.status.toUpperCase()}
          ----------------------------------
          Thank You! Visit Again!
        `;
        const printWindow = window.open('', '_blank');
        printWindow.document.write('<pre>' + receipt + '</pre>');
        printWindow.document.close();
        printWindow.focus();
        printWindow.print();
        printWindow.close();
      })
      .catch(error => {
        console.error('Error fetching order:', error);
        alert('Failed to fetch order. Please try again.');
      });
  }

  // Day Close
  document.getElementById('day-close-btn').addEventListener('click', () => {
    alert('Day Closed! Sales Summary Printed.');
    printSalesReport();
  });

  // Print Sales Report
  function printSalesReport() {
    db.ref('orders').once('value')
      .then(snapshot => {
        const data = snapshot.val();
        if (!data) {
          alert('No orders found.');
          return;
        }

        const today = new Date().toDateString();
        const todayOrders = Object.values(data).filter(o => 
          new Date(o.timestamp).toDateString() === today
        );
        const totalRevenue = todayOrders.reduce((sum, o) => sum + o.total, 0);
        const avgOrderValue = todayOrders.length ? (totalRevenue / todayOrders.length).toFixed(2) : 0;

        const report = `
          =============================
          TREEHOUSE BAKERY - DAILY SALES
          Date: ${today}
          =============================
          Total Orders: ${todayOrders.length}
          Total Revenue: â‚¹${totalRevenue}
          Avg Order Value: â‚¹${avgOrderValue}
          -----------------------------
          Top Sellers:
          - Margherita Pizza: 5
          - Chicken Burger: 4
          - Chutney Sandwich: 3
          -----------------------------
          Thank You for a Great Day!
        `;
        const printWindow = window.open('', '_blank');
        printWindow.document.write('<pre>' + report + '</pre>');
        printWindow.document.close();
        printWindow.focus();
        printWindow.print();
        printWindow.close();
      })
      .catch(error => {
        console.error('Error fetching orders:', error);
        alert('Failed to generate report. Please try again.');
      });
  }

  // Load Menu Data from Firebase (for real-time sync)
  db.ref('menu').on('value', (snapshot) => {
    const data = snapshot.val();
    if (data) {
      menuData = Object.values(data);
      renderMenuList();
    }
  });

  // Save Menu Data to Firebase
  function saveMenuToFirebase() {
    const menuObj = {};
    menuData.forEach(item => {
      menuObj[item.id] = item;
    });
    db.ref('menu').set(menuObj)
      .then(() => {
        console.log('Menu saved to Firebase');
      })
      .catch(error => {
        console.error('Error saving menu:', error);
      });
  }

  // Override menuData.save to call saveMenuToFirebase
  menuData.save = saveMenuToFirebase;

  // Initial load of menu from Firebase
  db.ref('menu').once('value')
    .then(snapshot => {
      const data = snapshot.val();
      if (data) {
        menuData = Object.values(data);
        renderMenuList();
      }
    })
    .catch(error => {
      console.error('Error loading menu:', error);
    });

  // Play buzz sound when new order is received
  db.ref('orders').on('child_added', (snapshot) => {
    const order = snapshot.val();
    if (order.status === 'pending_payment') {
      const audio = document.getElementById('buzz-sound');
      audio.currentTime = 0;
      audio.play().catch(e => console.log("Audio play failed:", e));
    }
  });
</script>
</body>
</html>