<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Panel - TreeHouse Bakery</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f8f9fa;
    }

    .menu-category {
      color: #dc3545;
      border-bottom: 2px solid #dc3545;
      padding-bottom: 5px;
      margin-top: 20px;
    }

    .menu-item {
      background-color: white;
      transition: background-color 0.2s;
    }

    .menu-item:hover {
      background-color: #f1f1f1;
    }

    .cart-section {
      border: 1px solid #ddd;
      border-radius: 8px;
    }

    .cart-item {
      background-color: #fff;
      padding: 10px;
      margin-bottom: 5px;
      border: 1px solid #eee;
      border-radius: 5px;
    }

    .tab-content {
      padding: 20px;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal-dialog {
      width: 400px;
      max-width: 90%;
    }

    .list-group-item {
      cursor: pointer;
    }

    .list-group-item:hover {
      background-color: #f8f9fa;
    }

    @media (max-width: 768px) {
      .menu-category {
        font-size: 1.2rem;
      }
    }
  </style>
</head>

<body>

  <div id="login-screen" class="container-fluid d-flex justify-content-center align-items-center vh-100">
    <div class="card p-4" style="max-width: 400px;">
      <h3 class="text-center mb-4">Admin Login</h3>
      <input type="password" id="admin-password" class="form-control mb-3" placeholder="Password" />
      <button id="login-btn" class="btn btn-primary w-100">Login</button>
    </div>
  </div>

  <div id="admin-panel" class="container-fluid d-none">
    <header class="bg-dark text-white p-3 d-flex justify-content-between align-items-center">
      <h1>TreeHouse Bakery Admin</h1>
      <button id="logout-btn" class="btn btn-outline-light">Logout</button>
    </header>

    <div class="row mt-3">
      <!-- Sidebar -->
      <div class="col-md-3">
        <div class="list-group">
          <a href="#" class="list-group-item list-group-item-action active" data-tab="dashboard">Dashboard</a>
          <a href="#" class="list-group-item list-group-item-action" data-tab="menu">Menu Management</a>
          <a href="#" class="list-group-item list-group-item-action" data-tab="orders">Current Orders</a>
          <a href="#" class="list-group-item list-group-item-action" data-tab="past-orders">Past Orders</a>
          <a href="#" class="list-group-item list-group-item-action" data-tab="settings">Settings</a>
          <a href="#" class="list-group-item list-group-item-action" data-tab="reports">Reports</a>
        </div>
      </div>

      <!-- Main Content -->
      <div class="col-md-9">
        <!-- Dashboard Tab -->
        <div id="dashboard-tab" class="tab-content">
          <h4>Today's Summary</h4>
          <div class="row mb-4">
            <div class="col-6">
              <div class="card bg-info text-white">
                <div class="card-body">
                  <h5>Total Orders</h5>
                  <span id="total-orders">0</span>
                </div>
              </div>
            </div>
            <div class="col-6">
              <div class="card bg-success text-white">
                <div class="card-body">
                  <h5>Total Revenue</h5>
                  <span id="total-revenue">â‚¹0</span>
                </div>
              </div>
            </div>
          </div>
          <button id="day-close-btn" class="btn btn-danger">Day Close & Print Summary</button>
        </div>

        <!-- Menu Tab -->
        <div id="menu-tab" class="tab-content d-none">
          <h4>Menu Management</h4>
          <div class="mb-3">
            <button id="add-item-btn" class="btn btn-primary">+ Add New Item</button>
          </div>
          <div id="menu-list" class="list-group"></div>
        </div>

        <!-- Orders Tab -->
        <div id="orders-tab" class="tab-content d-none">
          <h4>Current Orders</h4>
          <div id="current-orders-list" class="list-group"></div>
        </div>

        <!-- Past Orders Tab -->
        <div id="past-orders-tab" class="tab-content d-none">
          <h4>Past Orders</h4>
          <div id="past-orders-list" class="list-group"></div>
        </div>

        <!-- Settings Tab -->
        <div id="settings-tab" class="tab-content d-none">
          <h4>Settings</h4>
          <div class="mb-3">
            <label>UPI ID:</label>
            <input type="text" id="upi-id" class="form-control mb-2" value="9673553554@ptsbi" />
          </div>
          <div class="mb-3">
            <label>Hotel Name:</label>
            <input type="text" id="hotel-name" class="form-control mb-2" value="Taj Mahal Palace" />
          </div>
          <button id="save-settings-btn" class="btn btn-success">Save Settings</button>
        </div>

        <!-- Reports Tab -->
        <div id="reports-tab" class="tab-content d-none">
          <h4>Daily Sales Report</h4>
          <div id="sales-report" class="bg-light p-3 rounded">
            Loading...
          </div>
          <button id="print-report-btn" class="btn btn-primary mt-3">Print Today's Sales</button>
        </div>
      </div>
    </div>

    <!-- Hidden Modal for Add/Edit Item -->
    <div id="item-modal" class="modal d-none">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Add/Edit Item</h5>
            <button type="button" class="btn-close" onclick="closeModal()"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="edit-item-id" />
            <div class="mb-3">
              <label>Name:</label>
              <input type="text" id="item-name" class="form-control" />
            </div>
            <div class="mb-3">
              <label>Category:</label>
              <select id="item-category" class="form-select">
                <option value="pizza">Pizza</option>
                <option value="burger">Burger</option>
                <option value="sandwich">Sandwich</option>
                <option value="waffle">Waffles & Shake</option>
                <option value="tea">Tea/Coffee & More</option>
              </select>
            </div>
            <div class="mb-3">
              <label>Price (â‚¹):</label>
              <input type="number" id="item-price" class="form-control" />
            </div>
            <div class="mb-3">
              <label>Out of Stock?</label>
              <input type="checkbox" id="item-out-of-stock" />
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button type="button" id="save-item-btn" class="btn btn-primary">Save</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <audio id="buzz-sound" src="assets/buzz.mp3" preload="auto"></audio>

  <script>
    // Admin Login Logic
    document.getElementById('login-btn').addEventListener('click', () => {
      const pass = document.getElementById('admin-password').value;
      if (pass === 'tree123') {
        document.getElementById('login-screen').classList.add('d-none');
        document.getElementById('admin-panel').classList.remove('d-none');
        loadAdminData();
        startAutoRefresh(); // Start auto-refresh every 5 seconds
      } else {
        alert('Wrong password!');
      }
    });
  
    // Logout
    document.getElementById('logout-btn').addEventListener('click', () => {
      document.getElementById('admin-panel').classList.add('d-none');
      document.getElementById('login-screen').classList.remove('d-none');
      document.getElementById('admin-password').value = '';
      stopAutoRefresh();
    });
  
    // Tab Switching
    document.querySelectorAll('[data-tab]').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        const tabId = e.target.getAttribute('data-tab');
        document.querySelectorAll('.tab-content').forEach(el => el.classList.add('d-none'));
        document.getElementById(`${tabId}-tab`).classList.remove('d-none');
        document.querySelectorAll('.list-group-item').forEach(el => el.classList.remove('active'));
        e.target.classList.add('active');
      });
    });
  
    // Auto-refresh orders every 5 seconds
    let refreshInterval;
  
    function startAutoRefresh() {
      refreshInterval = setInterval(() => {
        renderCurrentOrders();
        renderPastOrders();
        renderDashboard();
      }, 5000); // Every 5 seconds
    }
  
    function stopAutoRefresh() {
      clearInterval(refreshInterval);
    }
  
    // Load Admin Data
    function loadAdminData() {
      renderDashboard();
      renderMenuList();
      renderCurrentOrders();
      renderPastOrders();
    }
  
    // Render Dashboard
    function renderDashboard() {
      const orders = JSON.parse(localStorage.getItem('orders') || '[]');
      const today = new Date().toDateString();
      const todayOrders = orders.filter(o => new Date(o.timestamp).toDateString() === today);
      const totalRevenue = todayOrders.reduce((sum, o) => sum + o.total, 0);
  
      document.getElementById('total-orders').textContent = todayOrders.length;
      document.getElementById('total-revenue').textContent = `â‚¹${totalRevenue}`;
    }
  
    // Render Menu List
    function renderMenuList() {
      const menuList = document.getElementById('menu-list');
      menuList.innerHTML = `
        <div class="list-group-item d-flex justify-content-between align-items-center">
          Margherita Pizza - â‚¹180
          <div>
            <button class="btn btn-sm btn-warning me-1" onclick="editItem(1)">Edit</button>
            <button class="btn btn-sm btn-danger" onclick="deleteItem(1)">Delete</button>
          </div>
        </div>
        <div class="list-group-item d-flex justify-content-between align-items-center">
          Veg Cheese Pizza - â‚¹200
          <div>
            <button class="btn btn-sm btn-warning me-1" onclick="editItem(2)">Edit</button>
            <button class="btn btn-sm btn-danger" onclick="deleteItem(2)">Delete</button>
          </div>
        </div>
        <!-- Add more items... -->
      `;
    }
  
    // Edit Item
    function editItem(id) {
      document.getElementById('edit-item-id').value = id;
      document.getElementById('item-name').value = 'Margherita Pizza';
      document.getElementById('item-category').value = 'pizza';
      document.getElementById('item-price').value = 180;
      document.getElementById('item-out-of-stock').checked = false;
      document.getElementById('item-modal').classList.remove('d-none');
    }
  
    // Save Item
    document.getElementById('save-item-btn').addEventListener('click', () => {
      const id = document.getElementById('edit-item-id').value;
      const name = document.getElementById('item-name').value;
      const category = document.getElementById('item-category').value;
      const price = document.getElementById('item-price').value;
      const outOfStock = document.getElementById('item-out-of-stock').checked;
      alert(`Saved: ${name} - â‚¹${price} (${category}) [Out of Stock: ${outOfStock}]`);
      closeModal();
      renderMenuList();
    });
  
    // Close Modal
    function closeModal() {
      document.getElementById('item-modal').classList.add('d-none');
    }
  
    // Add New Item
    document.getElementById('add-item-btn').addEventListener('click', () => {
      document.getElementById('edit-item-id').value = '';
      document.getElementById('item-name').value = '';
      document.getElementById('item-category').value = 'pizza';
      document.getElementById('item-price').value = '';
      document.getElementById('item-out-of-stock').checked = false;
      document.getElementById('item-modal').classList.remove('d-none');
    });
  
    // Render Current Orders (Dynamic)
    function renderCurrentOrders() {
      const ordersList = document.getElementById('current-orders-list');
      const orders = JSON.parse(localStorage.getItem('orders') || '[]').filter(o => o.status !== 'delivered');
  
      if (orders.length === 0) {
        ordersList.innerHTML = '<p class="text-muted p-3">No current orders.</p>';
        return;
      }
  
      let html = '';
      orders.forEach(order => {
        html += `
          <div class="list-group-item">
            <strong>Order #${order.id}</strong><br>
            ${order.customer.name} | Room ${order.customer.room}<br>
            Phone: ${order.customer.phone}<br>
            ${order.items.map(item => `${item.name} x${item.qty}`).join(', ')}<br>
            Total: â‚¹${order.total}<br>
            <div class="mt-2">
              <button class="btn btn-sm btn-info" onclick="markReady(${order.id})">Mark Ready</button>
              <button class="btn btn-sm btn-warning" onclick="markPickedUp(${order.id})">Mark Picked Up</button>
              <button class="btn btn-sm btn-success" onclick="markDelivered(${order.id})">Mark Delivered</button>
              <button class="btn btn-sm btn-secondary" onclick="printReceipt(${order.id})">Print Receipt</button>
              <button class="btn btn-sm btn-primary ms-1" onclick="confirmOrder(${order.id})">âœ… Confirm Order</button>
            </div>
          </div>
        `;
      });
  
      ordersList.innerHTML = html;
    }
  
    // Render Past Orders
    function renderPastOrders() {
      const ordersList = document.getElementById('past-orders-list');
      const orders = JSON.parse(localStorage.getItem('orders') || '[]').filter(o => o.status === 'delivered');
  
      if (orders.length === 0) {
        ordersList.innerHTML = '<p class="text-muted p-3">No past orders.</p>';
        return;
      }
  
      let html = '';
      orders.forEach(order => {
        html += `
          <div class="list-group-item">
            <strong>Order #${order.id}</strong><br>
            ${order.customer.name} | Room ${order.customer.room}<br>
            Phone: ${order.customer.phone}<br>
            ${order.items.map(item => `${item.name} x${item.qty}`).join(', ')}<br>
            Total: â‚¹${order.total}<br>
            <div class="mt-2">
              <button class="btn btn-sm btn-secondary" onclick="printReceipt(${order.id})">Print Receipt</button>
            </div>
          </div>
        `;
      });
  
      ordersList.innerHTML = html;
    }
  
    // Mark Order Status
    function markReady(id) {
      const orders = JSON.parse(localStorage.getItem('orders') || '[]');
      const order = orders.find(o => o.id == id);
      if (order) {
        order.status = 'ready';
        localStorage.setItem('orders', JSON.stringify(orders));
        renderCurrentOrders();
        renderDashboard();
      }
    }
  
    function markPickedUp(id) {
      const orders = JSON.parse(localStorage.getItem('orders') || '[]');
      const order = orders.find(o => o.id == id);
      if (order) {
        order.status = 'picked_up';
        localStorage.setItem('orders', JSON.stringify(orders));
        renderCurrentOrders();
        renderPastOrders();
        renderDashboard();
        alert(`Order #${id} marked as PICKED UP â†’ moved to Past Orders`);
      }
    }
  
    function markDelivered(id) {
      const orders = JSON.parse(localStorage.getItem('orders') || '[]');
      const order = orders.find(o => o.id == id);
      if (order) {
        order.status = 'delivered';
        localStorage.setItem('orders', JSON.stringify(orders));
        renderCurrentOrders();
        renderPastOrders();
        renderDashboard();
        alert(`Order #${id} marked as DELIVERED`);
      }
    }
  
    // âœ… NEW: Confirm Order Button â†’ Send WhatsApp Message
    function confirmOrder(id) {
      const orders = JSON.parse(localStorage.getItem('orders') || '[]');
      const order = orders.find(o => o.id == id);
      if (!order) return;
  
      // Update order status to "confirmed"
      order.status = 'confirmed';
      localStorage.setItem('orders', JSON.stringify(orders));
  
      // Generate WhatsApp message
      const whatsappMsg = `Hi ${order.customer.name}, your order #${order.id} is confirmed! We'll deliver it to Room ${order.customer.room} in 20 minutes. Thank you for choosing TreeHouse Bakery! ðŸ•`;
  
      // Open WhatsApp with message
      const whatsappUrl = `https://wa.me/${order.customer.phone}?text=${encodeURIComponent(whatsappMsg)}`;
  
      window.open(whatsappUrl, '_blank');
  
      // Refresh UI
      renderCurrentOrders();
      alert(`Order #${id} confirmed! WhatsApp message sent to ${order.customer.phone}`);
    }
  
    // Print Receipt
    function printReceipt(id) {
      const orders = JSON.parse(localStorage.getItem('orders') || '[]');
      const order = orders.find(o => o.id == id);
      if (!order) return;
  
      const receipt = `
        ----------------------------------
              TREEHOUSE BAKERY
           www.treehousebakery.com
           +91 9673553554
        ----------------------------------
        ORDER #${id}
        Date: ${new Date(order.timestamp).toLocaleString()}
        Room: ${order.customer.room} | Guest: ${order.customer.name}
        Phone: ${order.customer.phone}
        ----------------------------------
        ITEM                  QTY   AMT
        ----------------------------------
        ${order.items.map(item => `${item.name.padEnd(20)} ${item.qty}    â‚¹${item.price * item.qty}`).join('\n')}
        ----------------------------------
        TOTAL:                â‚¹${order.total}
        ----------------------------------
        STATUS: ${order.status.toUpperCase()}
        ----------------------------------
        Thank You! Visit Again!
      `;
      const printWindow = window.open('', '_blank');
      printWindow.document.write('<pre>' + receipt + '</pre>');
      printWindow.document.close();
      printWindow.focus();
      printWindow.print();
      printWindow.close();
    }
  
    // Day Close
    document.getElementById('day-close-btn').addEventListener('click', () => {
      alert('Day Closed! Sales Summary Printed.');
      printSalesReport();
    });
  
    // Print Sales Report
    function printSalesReport() {
      const orders = JSON.parse(localStorage.getItem('orders') || '[]');
      const today = new Date().toDateString();
      const todayOrders = orders.filter(o => new Date(o.timestamp).toDateString() === today);
      const totalRevenue = todayOrders.reduce((sum, o) => sum + o.total, 0);
      const avgOrderValue = todayOrders.length ? (totalRevenue / todayOrders.length).toFixed(2) : 0;
  
      const report = `
        =============================
        TREEHOUSE BAKERY - DAILY SALES
        Date: ${today}
        =============================
        Total Orders: ${todayOrders.length}
        Total Revenue: â‚¹${totalRevenue}
        Avg Order Value: â‚¹${avgOrderValue}
        -----------------------------
        Top Sellers:
        - Margherita Pizza: 5
        - Chicken Burger: 4
        - Chutney Sandwich: 3
        -----------------------------
        Thank You for a Great Day!
      `;
      const printWindow = window.open('', '_blank');
      printWindow.document.write('<pre>' + report + '</pre>');
      printWindow.document.close();
      printWindow.focus();
      printWindow.print();
      printWindow.close();
    }
  </script>
</body>

</html>